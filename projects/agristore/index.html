<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Our Farm | Livestock & Produce</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* Use aspect-ratio for consistent, responsive images */
    .card-img-top {
      width: 100%;
      aspect-ratio: 4 / 3;
      object-fit: cover;
      display: block;
    }

    /* Adjust font sizes for mobile to prevent overflow on small screens */
    @media (max-width: 576px) {
      .card-title {
        font-size: 0.9rem;
      }
      .btn-success {
        font-size: 0.8rem;
        padding: 8px 4px;
      }
      .input-group-text, .qty-input {
        font-size: 0.75rem;
      }
    }

    /* Badge positioning */
    .badge-new {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 2;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-success">
  <div class="container">
    <span class="navbar-brand fw-bold">üå± Our Farm</span>
  </div>
</nav>

<section class="container my-4">

  <input type="text" id="searchInput" class="form-control mb-3"
         placeholder="Search pigs, chicken, goats, matooke, rice...">

  <div class="mb-4 text-center">
    <button class="btn btn-outline-success filter-btn" data-category="all">All</button>
    <button class="btn btn-outline-success filter-btn" data-category="Livestock">Livestock</button>
    <button class="btn btn-outline-success filter-btn" data-category="Poultry">Poultry</button>
    <button class="btn btn-outline-success filter-btn" data-category="Crops">Crops</button>
  </div>

  <div id="loader" class="text-center my-5">Loading fresh produce...</div>

  <div class="row g-3" id="productGrid"></div>

</section>

<footer class="bg-light py-3 text-center">
  <small>üìç Uganda | üìû Call / WhatsApp to Order</small>
</footer>

<script>
const SHEET_URL = "https://opensheet.elk.sh/1YcwfYih0rUUqspsTMxjrdlMS5M1Fi5xBNIaLtFCoPBQ/Sheet1";
// Deploy an Apps Script web app that accepts POST and logs into a sheet.
// Replace with your deployed Apps Script URL below (see APPS_SCRIPT_DOPOST.md)
const TRACK_URL = "https://script.google.com/macros/s/AKfycbw4neByedX8FqNi_WGg_h2ulkbCC-9evlIFSIZffaAT8oZFIeaGjmXpY4EVc9aveZPKkw/exec";
const grid = document.getElementById("productGrid");
const searchInput = document.getElementById("searchInput");
const filterButtons = document.querySelectorAll(".filter-btn");
const loader = document.getElementById("loader");

let inventory = [];
let currentCategory = "all";

fetch(SHEET_URL)
  .then(res => res.json())
  .then(data => {
    inventory = data;
    loader.style.display = 'none';
    renderProducts();
  })
  .catch(err => {
    loader.innerText = 'Failed to load inventory.';
    console.error(err);
  });

function sanitizeId(id) { return String(id || '').replace(/[^a-zA-Z0-9-_]/g, '-'); }
function toBoolTrue(val) { return String(val || '').toUpperCase() === 'TRUE'; }
function parsePrice(val) {
  if (val === undefined || val === null || val === '') return NaN;
  const cleaned = String(val).replace(/[,‚Ç¶UGX\$ ]/g, '');
  return Number(cleaned);
}

function renderProducts() {
  grid.innerHTML = "";
  const searchText = (searchInput.value || '').toLowerCase();

  const filteredItems = inventory.filter(item => {
    const isAvailable = toBoolTrue(item.available);
    const matchesCategory = currentCategory === "all" || (String(item.category || '').toLowerCase() === String(currentCategory || '').toLowerCase());
    const nameLower = item.name ? String(item.name).toLowerCase() : '';
    const categoryLower = item.category ? String(item.category).toLowerCase() : '';
    const matchesSearch = nameLower.includes(searchText) || categoryLower.includes(searchText);
    return isAvailable && matchesCategory && matchesSearch;
  });

  if (filteredItems.length === 0) {
    grid.innerHTML = `<div class="text-center my-5 text-muted">No items found matching your search.</div>`;
    return;
  }

  filteredItems.forEach(item => {
    const notes = item.notes || "";
    const img = item.image || "https://via.placeholder.com/300x200?text=No+Image";
    const priceNum = parsePrice(item.price);
    const priceValue = (!isNaN(priceNum)) ? priceNum.toLocaleString() : null;
    const priceDisplay = priceValue ? `UGX ${priceValue}` : "Contact for Price";
    const safeId = sanitizeId(item.id || item.name || Math.random().toString(36).slice(2,8));

    grid.innerHTML += `
      <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4">
        <div class="card h-100 shadow-sm border-0 d-flex flex-column">
          ${toBoolTrue(item.new) ? '<span class="badge bg-success badge-new">NEW</span>' : ''}
          <img src="${img}" class="card-img-top" alt="${(item.name||'Product').replace(/"/g,'')}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
          
          <div class="card-body pb-0 d-flex flex-column">
            <h5 class="card-title fw-bold mb-0">${item.name||'Unnamed'}</h5>
            <p class="text-success fw-bold mb-2" style="font-size: 1.25rem;">${priceDisplay}</p>
            
            <div class="input-group input-group-sm mb-3" style="max-width: 140px; width: 100%;">
              <span class="input-group-text">Qty</span>
              <input type="number" class="form-control qty-input" value="1" min="1" id="qty-${safeId}">
            </div>

            <p class="text-muted small mb-1">Available: <strong>${item.quantity||0}</strong> ${item.unit||''}</p>
            <small class="text-secondary d-block mb-3">${notes}</small>
          </div>

          <div class="card-footer bg-white border-0 pt-0 pb-3 mt-auto">
            <div class="d-grid gap-2">
              <button data-name="${(item.name||'').replace(/"/g,'')}" data-id="${safeId}" data-price="${priceDisplay}" data-seller="256751200704" class="btn btn-success fw-bold wa-order-btn">
                Order via WhatsApp
              </button>
              <button data-seller="256751200704" data-item="${(item.id||safeId)}" data-name="${(item.name||'').replace(/"/g,'')}" class="btn btn-outline-secondary btn-sm track-call-btn">
                üìû Call Seller
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  });

  document.querySelectorAll('.wa-order-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const name = btn.dataset.name;
      const id = btn.dataset.id;
      const price = btn.dataset.price;
      const seller = btn.dataset.seller;
      sendWhatsApp(name, id, price, seller);
    });
  });

  document.querySelectorAll('.track-call-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const seller = btn.dataset.seller;
      const item = btn.dataset.item;
      const name = btn.dataset.name;
      trackAndRedirect({type:'call', item:item, seller:seller, name:name}, `tel:${seller}`, false);
    });
  });
}

searchInput.addEventListener("input", renderProducts);
filterButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    filterButtons.forEach(b => b.classList.remove('active', 'btn-success'));
    filterButtons.forEach(b => b.classList.add('btn-outline-success'));

    btn.classList.add('active', 'btn-success');
    btn.classList.remove('btn-outline-success');

    currentCategory = btn.dataset.category;
    renderProducts();
  });
});

function trackAndRedirect(payload, redirectUrl, openInBlank = true) {
  payload.ts = new Date().toISOString();
  payload.page = window.location.href;
  payload.referrer = document.referrer || '';
  payload.ua = navigator.userAgent || '';

  // Get quantity safely
  let quantity = '1';
  if (payload.item) {
    const qtyEl = document.getElementById(`qty-${sanitizeId(payload.item)}`);
    if (qtyEl) quantity = qtyEl.value;
  }
  payload.quantity = quantity;

  // Simple dev debounce (optional - remove in production)
  if (window.lastTrack && Date.now() - window.lastTrack < 1200) return;
  window.lastTrack = Date.now();

  try {
    const params = new URLSearchParams(Object.entries(payload));
    const fullUrl = TRACK_URL + '?' + params.toString();

    if (navigator.sendBeacon) {
      // Preferred - survives page unload. Note: sendBeacon usually takes (url, body);
      // using the URL with query params is acceptable for a simple ping.
      try { navigator.sendBeacon(fullUrl); } catch (e) { /* fallthrough to img fallback */ }
    } else {
      // Fallback (old browsers)
      const img = new Image();
      img.src = fullUrl + (fullUrl.includes('?') ? '&' : '?') + '_=' + Date.now();
    }
  } catch (err) {
    console.warn('Tracking failed', err);
  }

  // Do the actual redirect/action
  if (openInBlank) {
    window.open(redirectUrl, '_blank', 'noopener,noreferrer');
  } else {
    window.location.href = redirectUrl;
  }
}

function sendWhatsApp(name, id, price, seller) {
  const safeId = sanitizeId(id || name || '');
  const qtyEl = document.getElementById(`qty-${safeId}`);
  const qty = qtyEl ? qtyEl.value : 1;
  const text = `Hello! I'd like to order:\n\n*Item:* ${name}\n*Quantity:* ${qty}\n*Price:* ${price}\n\nIs this still available?`;
  const waUrl = `https://wa.me/${seller}?text=${encodeURIComponent(text)}`;
  trackAndRedirect({type:'wa', item:id||safeId, seller:seller, name:name, quantity:qty}, waUrl, true);
}
</script>
</body>
</html>

